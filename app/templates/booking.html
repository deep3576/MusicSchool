{% extends "base.html" %}
{% block content %}
<section class="page">
  <h1>Book a Class</h1>
  <p class="muted">Pick any available time. Teacher will be assigned automatically. Admin assigns class later.</p>

  {% if not current_user.is_authenticated %}
    <div class="card">
      <p>Please <a href="{{ url_for('main.login') }}">login</a> or <a href="{{ url_for('main.signup') }}">sign up</a> to book.</p>
    </div>
  {% endif %}

  <div class="card">
    <div id="calendar"></div>
  </div>
</section>

<div id="bookingModal" class="modal hidden">
  <div class="modal-backdrop"></div>
  <div class="modal-card">
    <div class="modal-head">
      <div>
        <div style="font-weight:950; font-size:18px;">Confirm Booking</div>
        <div class="muted" id="modalTime"></div>
      </div>
      <button class="btn secondary" type="button" id="modalClose">Close</button>
    </div>

    <form method="post" action="{{ url_for('main.book_submit') }}">
      {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
      <input type="hidden" name="availability_id" id="fAvailabilityId">
      <button class="btn" type="submit" style="width:100%;">Confirm</button>
    </form>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<script>
(function(){
  const isLoggedIn = {{ "true" if current_user.is_authenticated else "false" }};
  const modal = document.getElementById("bookingModal");
  const modalClose = document.getElementById("modalClose");
  const modalTime = document.getElementById("modalTime");
  const fAvailabilityId = document.getElementById("fAvailabilityId");

  function openModal(){ modal.classList.remove("hidden"); }
  function closeModal(){ modal.classList.add("hidden"); }
  modalClose.addEventListener("click", closeModal);
  modal.querySelector(".modal-backdrop").addEventListener("click", closeModal);

  const calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
    initialView: "timeGridWeek",
    height: "auto",
    allDaySlot: false,
    nowIndicator: true,
    headerToolbar: { left:"prev,next today", center:"title", right:"dayGridMonth,timeGridWeek,timeGridDay" },
    events: (fetchInfo, success, failure) => {
      const url = `/api/availability?start=${encodeURIComponent(fetchInfo.startStr)}&end=${encodeURIComponent(fetchInfo.endStr)}`;
      fetch(url).then(r => r.json()).then(success).catch(failure);
    },
    eventDisplay: "block",
    eventTimeFormat: { hour: "numeric", minute: "2-digit", meridiem: "short" },
    eventContent: (arg) => ({ html: `<div style="font-weight:950;">${arg.timeText}</div><div style="opacity:.85;">Available</div>` }),
    eventClick: (info) => {
      if(!isLoggedIn){ alert("Please login/signup first."); return; }
      fAvailabilityId.value = info.event.id;
      modalTime.textContent = `${info.event.start.toLocaleString()} â€” ${info.event.end.toLocaleString()}`;
      openModal();
    }
  });

  calendar.render();
})();
</script>
{% endblock %}
