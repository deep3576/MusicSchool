{% extends "base.html" %}
{% block content %}
<section class="page msg-page">
  <div class="page-head">
    <h1> Message Center</h1>
  </div>
   <div class="card admin-nav" style="margin-top:14px;">
    <a href="{{ url_for('admin.messages') }}" class="active">Messages</a>
    <a href="{{ url_for('admin.teachers') }}" >Teachers</a>
    <a href="{{ url_for('admin.venues') }}">Venues</a>
    <a href="{{ url_for('admin.syllabus') }}" >Syllabus</a>
    <a href="{{ url_for('admin.bookings') }}">Bookings</a>
    <a href="{{ url_for('admin.users') }}">Users</a>
  </div>




  <div class="msg-shell card" id="msgShell">
    <!-- LEFT: Threads -->
    <aside class="msg-left">
      <div class="msg-left-head">
        <div style="font-weight:950;">Inbox</div>

        <form method="get" class="msg-search">
          <input class="input" name="q" value="{{ q or '' }}" placeholder="Search name/email" />
          <button class="btn small" type="submit">Search</button>
          {% if q %}<a class="btn small secondary" href="{{ url_for('admin.messages') }}">Clear</a>{% endif %}
        </form>
      </div>

      <div class="msg-threads">
        {% if not threads %}
          <div class="muted" style="padding:12px;">No messages yet.</div>
        {% else %}
          {% for t in threads %}
            <a class="thread {{ 'active' if active_email==t.email else '' }}"
               href="{{ url_for('admin.messages', email=t.email) }}">
              <div class="avatar">{{ (t.name[:1] or 'U')|upper }}</div>

              <div class="thread-mid">
                <div class="thread-top">
                  <div class="thread-name">{{ t.name }}</div>
                  <div class="thread-time muted">{{ t.last_at.strftime("%b %d, %H:%M") if t.last_at else '' }}</div>
                </div>
                <div class="thread-sub muted">
                  {{ (t.last_subject ~ " · " if t.last_subject) ~ (t.last_message[:70] ~ ("…" if t.last_message|length>70 else "")) }}
                </div>
              </div>

              {% if t.pending and t.pending > 0 %}
                <div class="badge-pending">{{ t.pending }}</div>
              {% endif %}
            </a>
          {% endfor %}
        {% endif %}
      </div>
    </aside>

    <!-- RIGHT: Conversation -->
    <main class="msg-right">
      {% if not active_email %}
        <div class="empty-state">
          <div style="font-weight:950; font-size:18px;">Select a conversation</div>
          <div class="muted" style="margin-top:6px;">Choose a user from the left to view messages.</div>
        </div>
      {% else %}
        <div class="msg-right-head">
          <div>
            <div style="font-weight:950; font-size:16px;">{{ contact_name }}</div>
            <div class="muted" style="font-size:13px;">{{ active_email }}</div>
          </div>

          <div class="right-actions">
            <div class="pill">Pending: <b>{{ pending_for_active }}</b></div>
            <button class="btn small secondary mobile-only" type="button" onclick="toggleThreads()">Threads</button>
          </div>
        </div>

        <div class="msg-scroll" id="msgScroll">
          {% for m in convo %}
            <!-- Incoming -->
            <div class="bubble-row in">
              <div class="bubble {{ 'needs' if m.needs_reply else '' }}" data-mid="{{ m.id }}">
                {% if m.subject %}
                  <div class="subj">{{ m.subject }}</div>
                {% endif %}
                <div class="body">{{ m.message | e }}</div>
                <div class="meta">
                  {{ m.created_at.strftime("%b %d, %H:%M") if m.created_at else '' }}
                  {% if m.needs_reply %}<span class="needs-tag">Needs reply</span>{% endif %}
                </div>
              </div>
            </div>

            <!-- Outgoing reply (if exists) -->
            {% if m.reply_body and m.replied_at %}
              <div class="bubble-row out">
                <div class="bubble outb">
                  {% if m.reply_subject %}
                    <div class="subj">{{ m.reply_subject }}</div>
                  {% endif %}
                  <div class="body">{{ m.reply_body | e }}</div>
                  <div class="meta">{{ m.replied_at.strftime("%b %d, %H:%M") }}</div>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>

        <form class="reply-box" method="post" action="{{ url_for('admin.messages_send') }}">
          <input type="hidden" name="email" value="{{ active_email }}">
          <input type="hidden" name="message_id" id="message_id" value="">
          <input class="input" name="reply_subject" placeholder="Reply subject (optional)" />

          <textarea class="input textarea" name="reply_body" rows="2" placeholder="Type your reply..."></textarea>
          <button class="btn" type="submit">Send</button>

          <div class="muted" style="font-size:12px; margin-top:6px;">
            Tip: Click an unreplied message bubble to choose which message you’re replying to.
          </div>
        </form>
      {% endif %}
    </main>
  </div>

</section>

<style>
  .msg-page{ max-width: 1200px; margin: 0 auto; }
  .msg-shell{ padding:0; display:grid; grid-template-columns: 360px 1fr; min-height: 72vh; overflow:hidden; }

  .msg-left{ border-right: 1px solid rgba(0,0,0,.08); background: rgba(255,255,255,.72); }
  .msg-left-head{ padding: 12px; border-bottom: 1px solid rgba(0,0,0,.08); display:grid; gap:10px; }
  .msg-search{ display:flex; gap:8px; flex-wrap:wrap; }
  .btn.small{ padding:6px 10px; font-size:13px; }

  .msg-threads{ overflow:auto; max-height: calc(72vh - 90px); }
  .thread{
    display:flex; gap:10px; align-items:flex-start;
    padding: 10px 12px;
    border-bottom: 1px solid rgba(0,0,0,.06);
    text-decoration:none;
    color: inherit;
  }
  .thread:hover{ background: rgba(34,197,94,.06); }
  .thread.active{ background: rgba(34,197,94,.10); }

  .avatar{
    width:38px; height:38px;
    border-radius: 14px;
    background: rgba(34,197,94,.14);
    border: 1px solid rgba(34,197,94,.22);
    display:flex; align-items:center; justify-content:center;
    font-weight:950;
  }
  .thread-mid{ flex:1; min-width:0; }
  .thread-top{ display:flex; justify-content:space-between; gap:8px; align-items:center; }
  .thread-name{ font-weight:950; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .thread-sub{ font-size:12.5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:4px; }
  .badge-pending{
    min-width: 22px;
    height: 22px;
    padding: 0 6px;
    border-radius: 999px;
    background: rgba(220,38,38,.16);
    border: 1px solid rgba(220,38,38,.22);
    display:flex; align-items:center; justify-content:center;
    font-weight:950; font-size:12px;
  }

  .msg-right{ display:flex; flex-direction:column; background: rgba(255,255,255,.62); }
  .msg-right-head{
    padding: 12px;
    border-bottom: 1px solid rgba(0,0,0,.08);
    display:flex; justify-content:space-between; gap:10px; align-items:center;
  }
  .pill{
    padding:6px 10px;
    border-radius: 999px;
    border:1px solid rgba(0,0,0,.10);
    background: rgba(255,255,255,.7);
    font-weight:900;
    font-size:12px;
  }
  .right-actions{ display:flex; gap:8px; align-items:center; }
  .mobile-only{ display:none; }

  .msg-scroll{ padding: 14px; overflow:auto; flex:1; }

  .bubble-row{ display:flex; margin: 8px 0; }
  .bubble-row.in{ justify-content:flex-start; }
  .bubble-row.out{ justify-content:flex-end; }

  .bubble{
    max-width: 78%;
    padding: 10px 12px;
    border-radius: 18px;
    border: 1px solid rgba(0,0,0,.10);
    background: rgba(255,255,255,.78);
    cursor: default;
  }
  .bubble.needs{ border-color: rgba(220,38,38,.25); box-shadow: 0 0 0 2px rgba(220,38,38,.06); cursor:pointer; }
  .bubble.outb{ background: rgba(34,197,94,.10); border-color: rgba(34,197,94,.20); }

  .subj{ font-weight:950; margin-bottom:6px; }
  .body{ white-space:pre-wrap; }
  .meta{
    margin-top:8px;
    font-size: 11.5px;
    color: rgba(0,0,0,.55);
    display:flex; gap:8px; align-items:center;
  }
  .needs-tag{
    padding:2px 8px;
    border-radius:999px;
    background: rgba(220,38,38,.12);
    border:1px solid rgba(220,38,38,.18);
    font-weight:900;
    font-size:11px;
  }

  .reply-box{
    border-top: 1px solid rgba(0,0,0,.08);
    padding: 10px;
    display:grid;
    gap:10px;
    background: rgba(255,255,255,.72);
  }
  .textarea{ min-height: 52px; resize: vertical; }

  .empty-state{
    padding: 18px;
    margin: 18px;
    border-radius: 18px;
    border: 1px dashed rgba(0,0,0,.15);
    background: rgba(255,255,255,.72);
  }

  @media (max-width: 900px){
    .msg-shell{ grid-template-columns: 1fr; }
    .msg-left{ display:block; }
    .msg-right{ display:none; }
    .msg-shell.show-chat .msg-left{ display:none; }
    .msg-shell.show-chat .msg-right{ display:flex; }
    .mobile-only{ display:inline-flex; }
    .msg-threads{ max-height: calc(80vh - 90px); }
  }
</style>

<script>
  function toggleThreads(){
    const shell = document.getElementById("msgShell");
    if(shell) shell.classList.toggle("show-chat");
  }

  (function(){
    // Auto scroll to bottom
    const sc = document.getElementById("msgScroll");
    if(sc) sc.scrollTop = sc.scrollHeight;

    // On mobile, open chat if email is selected
    const active = "{{ active_email or '' }}";
    if(active && window.innerWidth <= 900){
      const shell = document.getElementById("msgShell");
      if(shell) shell.classList.add("show-chat");
    }

    // Default reply target: latest unreplied message bubble
    const hidden = document.getElementById("message_id");
    const needs = Array.from(document.querySelectorAll(".bubble.needs"));
    if(needs.length){
      const last = needs[needs.length - 1];
      hidden.value = last.getAttribute("data-mid") || "";
    }

    // Click unreplied bubble to set reply target
    needs.forEach(el => {
      el.addEventListener("click", () => {
        const mid = el.getAttribute("data-mid") || "";
        hidden.value = mid;
        needs.forEach(x => x.style.outline = "");
        el.style.outline = "2px solid rgba(34,197,94,.35)";
      });
    });
  })();
</script>
{% endblock %}
